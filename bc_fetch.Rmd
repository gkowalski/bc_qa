Breast Cancer QA Part 1: Fetch Data Files
=========================================

```{r echo=FALSE}
# Don't wrap so much
options(width=300) 
```

Data files were submitted to redcap:
 - [GPC Breast Cancer Project 1: review of survey population][4044]

[4044]: https://redcap.kumc.edu/redcap_v5.7.7/index.php?pid=4044

*TODO: cite relevant ticket.*

*TODO: attach data dictionary to ticket so others can try this code.*

Generate an API key and put it in the auxilary `bcread_api_key.R` file a la:

```{r eval=FALSE}
Sys.setenv(BCREAD='ABC...')
'BCREAD'
```

```{r echo=FALSE}
bc_access <- function(env.key, pyenv, src,
                      # TODO: document this least authority idiom
                      .system=system) {
  exportTemplate    <- 'bc_access --key <key> export'
  fetchTemplate     <- 'bc_access --key <key> fetch'
  normalizeTemplate <- 'bc_access normalize'
  
  pyscript <- gsub('PYENV', pyenv,
                   gsub('SRC', src,
                        'PYENV/bin/python SRC/bc_access.py'))
  
  expand <- function(tpl) {
    gsub('bc_access', pyscript,
         gsub('<key>', env.key, tpl))
  }
  
  form.data <- .system(expand(exportTemplate), intern=TRUE)
  fetch.detail <- .system(expand(fetchTemplate), intern=TRUE)
  normalize.detail <- .system(expand(normalizeTemplate), input=fetch.detail, intern=TRUE)
  
  # TODO: least-authority access to open data files
  list(form.data=form.data,
       fetch.detail=fetch.detail,
       normalize.detail=normalize.detail)
}

```

Then we can fetch all the survey and CRF data from that project as well as the submitted data files:

```{r}
env.key.bc <- source('bcread_api_key.R')$value

runDir <- getwd()

setwd("~/projects/bc_qa/data-files")
# get rid of existing data files
system("rm *")
fetch <- bc_access(env.key.bc, src=runDir, pyenv='/home/dconnolly/pyenv/bcqa')
fetch$dataDir <- getwd()

setwd(runDir)
```

The form data and file info were provided in CSV format:

```{r}
text.to.csv <- function(text)
  read.csv(textConnection(text),
           stringsAsFactors=FALSE)

fetch$form <- text.to.csv(fetch$form.data)
fetch$form[, c('record_id', 'institution', 'name')]

fetch$file <- text.to.csv(fetch$normalize.detail)
fetch$file
```

Let's combine the info about datasets:

```{r}
dataset <- merge(fetch$file, fetch$form,
                       by='record_id')
names(dataset)
dataset <- dataset[order(dataset$site),]

fetch$dataset <- dataset
fetch$dataset[, c('record_id', 'obsolete', 'institution', 'site', 'name', 'bc_db', 'patient_qty')]
```

We'll use this function to access the files:

```{r}
site.data <- function(target) {
  library(RSQLite)
  
  f <- file.path(fetch$dataDir, subset(fetch$file, site == target)$bc_db)
  dbConnect(SQLite(), dbname=f)
  }
fetch$site.data <- site.data
```

Save our work for use in later articles:

```{r}
save(fetch, file="bc_fetch_results.RData")
```
