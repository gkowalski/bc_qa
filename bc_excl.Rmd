```{r echo=FALSE}
SITE <- source('bc_site.R')$value
```


Breast Cancer QA for `r SITE`
=============================

*Based on results from previous articles*

```{r}
load("bc_fetch_results.RData")
load("bc_terms_results.RData")
```


```{r echo=FALSE}
# Transformation utilities:
source('bc_qa_txform.R')
```

```{r, echo=FALSE}
# Don't wrap so much
options(width=300) 
```


## Data Summary for `r SITE`

```{r echo=FALSE}
dataset <- subset(fetch$dataset, site == SITE)
dataset[, c('record_id', 'site', 'name', 'bc_db')]

conn.site <- site.data(SITE)

builder.summary(conn.site)[, c('variable', 'pat_qty', 'enc_qty', 'fact_qty')]
```

Issues noted in redcap:

```{r echo=FALSE}
cat(dataset$issues_other)
```

## Terms in dataset from `r SITE`

### Variable Terms: Aligned and Misaligned

```{r, echo=FALSE}
v <- dbGetQuery(conn.site,
"
select id, name, concept_path
from variable
")

# Some sites have really long variable names
v$name <- substr(v$name, 1, 40)
v.ok <- v$concept_path %in% bcterm$term204$concept_path
v.good <- v[v.ok, ]
v.bad <- v[! v.ok, ]

data.frame(
  qty.good=nrow(v.good),
  qty.bad=nrow(v.bad))
```

```{r}
v.good
v.bad
```

### Fact Terms: Misaligned

For facts with concept paths that don't match any of the requested terms, how many patients, encounters, and facts?

```{r echo=FALSE}

# KLUDGE rather than adding a table... or even a temp table...
sql.qterm.table <- (
  function() {
    select <- lapply(bcterm$term204$concept_path,
                     function(p) paste0("select '", p, "' concept_path"))
    paste(select, collapse=' union all\n')
    })()

bad.concept.path <-
  dbGetQuery(conn.site,
             paste(
             "select count(distinct patient_num) qty_pat,
                     count(distinct encounter_num) qty_enc,
                     count(*) qty_fact,
                     substr(cd.name_char, 1, 30) name_char,
                     cd.concept_path
             from observation_fact f
             join concept_dimension cd
             on cd.concept_cd = f.concept_cd
             where not exists (select t204.concept_path from
             (", sql.qterm.table, ") t204
             where cd.concept_path like (t204.concept_path || '%'))
             group by cd.concept_path
             "))
bad.concept.path
```

## Analytic Dataset is based on Breast Cancer Diagnosis

```{r}
bcterm$bc.dx.path
tumor.site <- v.enc(conn.site, bcterm$bc.dx.path, 'bc.dx')
```

We find `r nrow(tumor.site)` diagnoses; let's look at the first few:

```{r}
head(tumor.site)
```



### Sex

Let's be careful to continue to rely only on paths. For nominal variables, we focus on segments of the concept path that distinguish it from the variable:

```{r}
tumor.site <- with.var(tumor.site, conn.site,
                       bcterm$excl['sex', 'concept_path'], 'sex')

head(tumor.site)
```

This function summarizes a nominal (enumerated) variable:

```{r}
enum.sum <- function(data, v,
                     key='patient_num') {
  summary(unique(data[, c(key, v)])[[v]])
}

enum.sum(tumor.site, 'sex')
```

Let's visualize the breakdown:

```{r}
prop <- enum.sum(tumor.site, 'sex')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```


### Sequence Number


```{r}
tumor.site <- with.var(tumor.site, conn.site,
                       bcterm$excl['seq.no', 'concept_path'], 'seq.no')
head(tumor.site[, c(-3)])

prop <- enum.sum(tumor.site, 'seq.no')
pie(prop)
data.frame(qty=prop, row.names=names(prop))

```

### Diagnostic Confirmation

```{r}
tumor.site <- with.var(tumor.site, conn.site,
                       bcterm$excl['confirm', 'concept_path'], 'confirm')

head(tumor.site[, c(-3, -4)])

prop <- enum.sum(tumor.site, 'confirm')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

### Morphology Code

```{r}
tumor.site <- with.var(tumor.site, conn.site,
                       bcterm$excl['morphology', 'concept_path'], 'morphology')

head(tumor.site[, c(-3, -4, -5)])

prop <- enum.sum(tumor.site, 'morphology')
pie(prop)
```

Those codes aren't very satisfying; let's put the names back on:

```{r echo=FALSE}
# Put the names back on
enum.name <- function(x, path.var) {
  df <- data.frame(
    concept_path=paste0(path.var,
                        # chop off 1st character
                        substr(x, 2, length(x))))
  
  df <- merge(df,
              dbGetQuery(conn.site,
                         'select name_char, concept_path from concept_dimension'),
              by='concept_path',
              all.x=TRUE)
  df$name_char
}
```

```{r}
prop <- data.frame(qty=prop, row.names=names(prop))
prop$name <- enum.name(row.names(prop), bcterm$excl['morphology', 'concept_path'])
prop <- prop[prop$qty> 0, ]
pie(prop$qty, labels=prop$name)
prop[, c('name', 'qty')]
```

### Stage

Derived AJCC-7 Grp and/or SS2000

```{r}
tumor.site <- with.var(tumor.site, conn.site,
                       bcterm$excl.all['stage.ss', 'concept_path'], 'stage.ss')
tumor.site <- with.var(tumor.site, conn.site,
                       bcterm$excl.all['stage.ajcc', 'concept_path'], 'stage.ajcc')
tumor.site$stage <- factor.combine(tumor.site$stage.ss, tumor.site$stage.ajcc)

head(tumor.site[, c(-3, -4, -5, -6)])
```

#### Stage: 3020 Derived SS2000

```{r}
prop <- enum.sum(tumor.site, 'stage.ss')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Stage: 3430 Derived AJCC-7

```{r}
prop <- enum.sum(tumor.site, 'stage.ajcc')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Stage: Combined

```{r}
prop <- enum.sum(tumor.site, 'stage')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```


### Vital Status

```{r}
tumor.site <- with.var(tumor.site, conn.site,
                       bcterm$excl.all['vital.tr', 'concept_path'], 'vital.tr')
head(tumor.site[, c(-3, -4, -5, -6, -7)])
```

To match between the tumor registry and the EHR, we can only join on patient num.

```{r}
tumor.site <- with.var.pat(tumor.site, conn.site,
                           bcterm$excl.all['deceased.ehr', 'concept_path'],
                           'deceased.ehr')
tumor.site <- with.var.pat(tumor.site, conn.site,
                           bcterm$excl.all['deceased.ssa', 'concept_path'],
                           'deceased.ssa')
tumor.site$vital <- factor.combine(tumor.site$vital.tr,
                                   tumor.site$deceased.ehr,
                                   tumor.site$deceased.ssa)
  
head(tumor.site[, c(-3, -4, -5, -6, -7, -8, -9)])
```

#### Vital Status: Tumor Registry

```{r}
prop <- enum.sum(tumor.site, 'vital.tr')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Vital Status: Deceased (from EHR)

```{r}
prop <- enum.sum(tumor.site, 'deceased.ehr')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Vital Status: Deceased (from SSA)

```{r}
prop <- enum.sum(tumor.site, 'deceased.ssa')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Vital Status: All Sources

```{r}
prop <- enum.sum(tumor.site, 'vital')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```


## Summary and Issues for `r SITE`

```{r}
summary(tumor.site[, row.names(bcterm$excl)])

show.issues(tumor.site, bcterm$excl)
```
