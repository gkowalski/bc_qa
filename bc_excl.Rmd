```{r echo=FALSE}
SITE <- source('bc_site.R')$value
```


Breast Cancer QA for `r SITE`
=============================

*Based on results from previous articles*

```{r}
load("bc_fetch_results.RData")
load("bc_terms_results.RData")
```


```{r echo=FALSE}
# Transformation utilities:
source('bc_qa_txform.R')
```

```{r, echo=FALSE}
# Don't wrap so much
options(width=300) 
```


## Data Summary for `r SITE`

```{r echo=FALSE}
dataset <- subset(fetch$dataset, site == SITE)
dataset[, c('record_id', 'site', 'name', 'bc_db')]

conn.site <- site.data(SITE)

builder.summary(conn.site)[, c('variable', 'pat_qty', 'enc_qty', 'fact_qty')]
```

Issues noted in redcap:

```{r echo=FALSE}
cat(dataset$issues_other)
```

## Terms in dataset from `r SITE`

### Variable Terms: Aligned and Misaligned

```{r, echo=FALSE}
v <- dbGetQuery(conn.site,
"
select id, name, concept_path
from variable
")

# Some sites have really long variable names
v$name <- substr(v$name, 1, 40)
v.ok <- v$concept_path %in% bcterm$term204$concept_path
v.good <- v[v.ok, ]
v.bad <- v[! v.ok, ]

data.frame(
  qty.good=nrow(v.good),
  qty.bad=nrow(v.bad))
```

```{r}
v.good
v.bad
```

### Fact Terms: Misaligned

For facts with concept paths that don't match any of the requested terms, how many patients, encounters, and facts?

```{r echo=FALSE}

# KLUDGE rather than adding a table... or even a temp table...
sql.qterm.table <- (
  function() {
    select <- lapply(bcterm$term204$concept_path,
                     function(p) paste0("select '", p, "' concept_path"))
    paste(select, collapse=' union all\n')
    })()

bad.concept.path <-
  dbGetQuery(conn.site,
             paste(
             "select count(distinct patient_num) qty_pat,
                     count(distinct encounter_num) qty_enc,
                     count(*) qty_fact,
                     substr(cd.name_char, 1, 30) name_char,
                     cd.concept_path
             from observation_fact f
             join concept_dimension cd
             on cd.concept_cd = f.concept_cd
             where not exists (select t204.concept_path from
             (", sql.qterm.table, ") t204
             where cd.concept_path like (t204.concept_path || '%'))
             group by cd.concept_path
             "))
bad.concept.path
```

## Analytic Dataset is based on Breast Cancer Diagnosis

### Encounter variable

For present/absent variables, we can capture the observation fact start date while we're at it using this query:

Let's pick out the breast cancer term; as noted above, it seems to occur in the query twice, so we use `unique()`:

```{r}
var.dx <- unique(var204[grep('Breast', var204$name), c('concept_path', 'name')])
stopifnot(nrow(var.dx) == 1)
var.dx[, c('name', 'concept_path')]
```

### Breast Cancer Diagnoses at `r SITE`

```{r}
tumor.site <- v.enc(conn.site, var.dx$concept_path, 'bc.dx')
head(tumor.site)
```



### Sex


```{r}
var.sex <- var.excl['sex', ]
var.sex
```

For nominal variables, we focus on segments of the concept path that distinguish it from the variable.


```{r}
enum.sum <- function(data, v,
                     key='patient_num') {
  summary(unique(data[, c(key, v)])[[v]])
}
```

```{r}
tumor.site <- with.var(tumor.site, conn.site, var.sex$concept_path, 'sex')

head(tumor.site)

prop <- enum.sum(tumor.site, 'sex')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```


### Sequence Number

```{r}
var.seq <- var.excl['seq.no', ]
```


```{r}
tumor.site <- with.var(tumor.site, conn.site, var.seq$concept_path, 'seq.no')
head(tumor.site)

prop <- enum.sum(tumor.site, 'seq.no')
pie(prop)
data.frame(qty=prop, row.names=names(prop))

```

### Diagnostic Confirmation

```{r}
var.confirm <- var.excl['confirm', ]
var.confirm
```


```{r}
tumor.site <- with.var(tumor.site, conn.site, var.confirm$concept_path, 'confirm')

head(tumor.site)

prop <- enum.sum(tumor.site, 'confirm')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

### Morphology Code

```{r}
var.morph <- var.excl['morphology', ]
var.morph
```


```{r}
tumor.site <- with.var(tumor.site, conn.site, var.morph$concept_path, 'morphology')

head(tumor.site)

prop <- enum.sum(tumor.site, 'morphology')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

### Stage

Derived AJCC-7 Grp and/or SS2000

```{r}
var.stage.ss <- var204[grep('3020 Derived SS2000', var204$name), ]
var.stage.ajcc <- var204[grep('3430 Derived AJCC-7', var204$name), ]

stopifnot(nrow(var.stage.ss) == 1)
stopifnot(nrow(var.stage.ajcc) == 1)
var.stage.ajcc
var.stage.ss
```


```{r}
tumor.site <- with.var(tumor.site, conn.site, var.stage.ss$concept_path, 'stage.ss')
tumor.site <- with.var(tumor.site, conn.site, var.stage.ajcc$concept_path, 'stage.ajcc')
tumor.site$stage <- factor.combine(tumor.site$stage.ss, tumor.site$stage.ajcc)
  
head(tumor.site)
```

#### Stage: 3020 Derived SS2000

```{r}
prop <- enum.sum(tumor.site, 'stage.ss')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Stage: 3430 Derived AJCC-7

```{r}
prop <- enum.sum(tumor.site, 'stage.ajcc')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Stage: Combined

```{r}
prop <- enum.sum(tumor.site, 'stage')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```


### Vital Status

```{r}
var.vital.tr <- var204[grep('1760 Vital', var204$name), ]
var.deceased.ehr <- var204[grep('\\\\Deceased\\\\', var204$concept_path), ]
var.deceased.ssa <- var204[grep('\\\\Deceased per SSA\\\\', var204$concept_path), ]

var.vital.tr
var.deceased.ehr
var.deceased.ssa
```


To match between the tumor registry and the EHR, we can only join on patient num.

```{r}
tumor.site <- with.var(tumor.site, conn.site, var.vital.tr$concept_path, 'vital.tr')

tumor.site <- with.var.pat(tumor.site, conn.site, var.deceased.ehr$concept_path, 'deceased.ehr')
tumor.site <- with.var.pat(tumor.site, conn.site, var.deceased.ssa$concept_path, 'deceased.ssa')
tumor.site$vital <- factor.combine(tumor.site$vital.tr,
                                   tumor.site$deceased.ehr,
                                   tumor.site$deceased.ssa)
  
head(tumor.site)
```

#### Vital Status: Tumor Registry

```{r}
prop <- enum.sum(tumor.site, 'vital.tr')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Vital Status: Deceased (from EHR)

```{r}
prop <- enum.sum(tumor.site, 'deceased.ehr')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Vital Status: Deceased (from SSA)

```{r}
prop <- enum.sum(tumor.site, 'deceased.ssa')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Vital Status: All Sources

```{r}
prop <- enum.sum(tumor.site, 'vital')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```


## Save For Next Section

```{r}
save(dataDir, got, submission,
     current, site.data, builder.summary, strip.counts,
     var.excl, var204,
     file="bc_data_excl.RData")
```

## Summary and Issues for `r SITE`

```{r}
summary(tumor.site[, row.names(var.excl)])

show.issues(tumor.site, var.excl)
```
