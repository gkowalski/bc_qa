Breast Cancer QA: Query Terms and Exclusion Criteria
====================================================

Choose the site in this auxiliary file:

```{r}
SITE <- source('bc_site.R')$value
```


*Transformation and access utilities:*

```{r}
source('bc_qa_txform.R')
```

```{r, echo=FALSE}
load("bc_data_summary.RData")
```

```{r, echo=FALSE}
# Don't wrap so much
options(width=300) 
```

## Query Terms

 Query sent to GPC sites 12/23/2014:

  - [GPC Honest Brokers: Time to run the breast cancer survey query][23dec]
    Tamara McMahon
    Tue Dec 23 16:17:23 CST 2014 

[23dec]: http://listserv.kumc.edu/pipermail/gpc-honest-brokers/2014-December/000002.html

cf. [ticket:204][204]

[204]: https://informatics.gpcnetwork.org/trac/Project/ticket/204

From a KUMC data file, we extracted the variable table in [bc-variable.csv][222b] on Feb 9 using:

    sqlite3 -header -csv kumcBC.db 'select * from variable' >bc-variable.csv 

[222b]:  https://informatics.gpcnetwork.org/trac/Project/attachment/ticket/222/bc-variable.csv

*Note: R doubles backslashes when it displays strings.*

```{r}
var204 <- read.csv('bc-variable.csv',
                   stringsAsFactors=FALSE)

var204$name <- strip.counts(var204$name_char)
var204 <- var204[, c('id', 'concept_path', 'name')]
var204[, c('concept_path', 'name')]

```

We seem to have some duplicates:
```{r}
var204[duplicated(var204$concept_path), ]
data.frame(
  term.qty=nrow(var204),
  term.uniq.qty=length(unique(var204$concept_path))
  )
```

## Analytic Dataset is based on Breast Cancer Diagnosis

### Site Data Summary (`r SITE`)

```{r}
SITE
subset(current, site == SITE)[, c('record_id', 'site', 'name', 'filename')]

cat(subset(current, site == SITE)$issues_other)

conn.site <- site.data(SITE, dataDir, current)

builder.summary(conn.site)[, c('variable', 'pat_qty', 'enc_qty', 'fact_qty')]
```

### Encounter variable

For present/absent variables, we can capture the observation fact start date while we're at it using this query:

Let's pick out the breast cancer term; as noted above, it seems to occur in the query twice, so we use `unique()`:

```{r}
var.dx <- unique(var204[grep('Breast', var204$name), c('concept_path', 'name')])
stopifnot(nrow(var.dx) == 1)
var.dx[, c('name', 'concept_path')]
```

### Breast Cancer Diagnoses at `r SITE`

```{r}
tumor.site <- v.enc(conn.site, var.dx$concept_path, 'bc.dx')
head(tumor.site)
```


## Exclusion Criteria

From Tamara McMahon's message of Thursday, February 19, 2015 9:03 AM:

> Here are the variables needed for exclusion (e.g., minimum variables required by all institutions)
 
```{r}
var.excl <- data.frame(
  tm=c(
    'Sex',
    'Sequence Number',
    'Diagnostic Confirmation',
    'Morphology Code',
    'Derived AJCC-7 Grp and/or SS2000',
    'Vital Status'
    ),
  id=NA,
  name=NA,
  concept_path=NA
  )

row.names(var.excl) <- c('sex', 'seq.no', 'confirm', 'morphology', 'stage', 'vital')

set.excl <- function(name, term) {
  stopifnot(nrow(term) == 1)
  var.excl[name, 'id'] <<- term$id
  var.excl[name, 'name'] <<- term$name
  var.excl[name, 'concept_path'] <<- term$concept_path
}

set.excl('sex', var204[grep('0220 Sex', var204$name), ])
set.excl('seq.no', var204[grep('0380 Sequence Number', var204$name), ])
set.excl('confirm', var204[grep('0490 Diagnostic Confirmation', var204$name), ])
set.excl('morphology', var204[grep('0521 Morph', var204$name), ])

var.excl
```


### Sex


```{r}
var.sex <- var.excl['sex', ]
var.sex
```

For nominal variables, we focus on segments of the concept path that distinguish it from the variable.


```{r}
enum.sum <- function(data, v,
                     key='patient_num') {
  summary(unique(data[, c(key, v)])[[v]])
}
```

```{r}
tumor.site <- with.var(tumor.site, conn.site, var.sex$concept_path, 'sex')

head(tumor.site)

prop <- enum.sum(tumor.site, 'sex')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```


### Sequence Number

```{r}
var.seq <- var.excl['seq.no', ]
```


```{r}
tumor.site <- with.var(tumor.site, conn.site, var.seq$concept_path, 'seq.no')
head(tumor.site)

prop <- enum.sum(tumor.site, 'seq.no')
pie(prop)
data.frame(qty=prop, row.names=names(prop))

```

### Diagnostic Confirmation

```{r}
var.confirm <- var.excl['confirm', ]
var.confirm
```


```{r}
tumor.site <- with.var(tumor.site, conn.site, var.confirm$concept_path, 'confirm')

head(tumor.site)

prop <- enum.sum(tumor.site, 'confirm')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

### Morphology Code

```{r}
var.morph <- var.excl['morphology', ]
var.morph
```


```{r}
tumor.site <- with.var(tumor.site, conn.site, var.morph$concept_path, 'morphology')

head(tumor.site)

prop <- enum.sum(tumor.site, 'morphology')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

### Stage

Derived AJCC-7 Grp and/or SS2000

```{r}
var.stage.ss <- var204[grep('3020 Derived SS2000', var204$name), ]
var.stage.ajcc <- var204[grep('3430 Derived AJCC-7', var204$name), ]

stopifnot(nrow(var.stage.ss) == 1)
stopifnot(nrow(var.stage.ajcc) == 1)
var.stage.ajcc
var.stage.ss
```


```{r}
tumor.site <- with.var(tumor.site, conn.site, var.stage.ss$concept_path, 'stage.ss')
tumor.site <- with.var(tumor.site, conn.site, var.stage.ajcc$concept_path, 'stage.ajcc')
tumor.site$stage <- factor.combine(tumor.site$stage.ss, tumor.site$stage.ajcc)
  
head(tumor.site)
```

#### Stage: 3020 Derived SS2000

```{r}
prop <- enum.sum(tumor.site, 'stage.ss')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Stage: 3430 Derived AJCC-7

```{r}
prop <- enum.sum(tumor.site, 'stage.ajcc')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Stage: Combined

```{r}
prop <- enum.sum(tumor.site, 'stage')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```


### Vital Status

```{r}
var.vital.tr <- var204[grep('1760 Vital', var204$name), ]
var.deceased.ehr <- var204[grep('\\\\Deceased\\\\', var204$concept_path), ]
var.deceased.ssa <- var204[grep('\\\\Deceased per SSA\\\\', var204$concept_path), ]

var.vital.tr
var.deceased.ehr
var.deceased.ssa
```


To match between the tumor registry and the EHR, we can only join on patient num.

```{r}
tumor.site <- with.var(tumor.site, conn.site, var.vital.tr$concept_path, 'vital.tr')

tumor.site <- with.var.pat(tumor.site, conn.site, var.deceased.ehr$concept_path, 'deceased.ehr')
tumor.site <- with.var.pat(tumor.site, conn.site, var.deceased.ssa$concept_path, 'deceased.ssa')
tumor.site$vital <- factor.combine(tumor.site$vital.tr,
                                   tumor.site$deceased.ehr,
                                   tumor.site$deceased.ssa)
  
head(tumor.site)
```

#### Vital Status: Tumor Registry

```{r}
prop <- enum.sum(tumor.site, 'vital.tr')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Vital Status: Deceased (from EHR)

```{r}
prop <- enum.sum(tumor.site, 'deceased.ehr')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Vital Status: Deceased (from SSA)

```{r}
prop <- enum.sum(tumor.site, 'deceased.ssa')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```

#### Vital Status: All Sources

```{r}
prop <- enum.sum(tumor.site, 'vital')
pie(prop)
data.frame(qty=prop, row.names=names(prop))
```


## Save For Next Section

```{r}
save(dataDir, got, submission,
     current, site.data, builder.summary, strip.counts,
     var.excl,
     file="bc_data_excl.RData")
```

## Summary and Issues for `r SITE`

```{r}
summary(tumor.site[, row.names(var.excl)])

show.issues(tumor.site, var.excl)
```
