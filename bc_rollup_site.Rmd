# Breast Cancer - Roll-up Site Data
```{r echo=FALSE}
# ============================================================================
###  Creates site-specific tumor-level datamart
# Input Dataframes
#   dataset       - desriptors for site's input dataset 
#   tumor.site    - pt tumors listing
#   survey.sample - complex frame created by bc_excl
# 
# Note - script was modeled after 'bc_random_smaple.rmd'
#
# 11-Sep Genesis
# 22-Sep SAVEPOINT (RMD file committed to TortoiseHg)
# 22-Sep Embed 'code.descriptor' (code and code.name) into column value, instead of just code
# 22-Sep De-couple 'AddVariable' and 'DescribeVariable'
# 22-Sep Handles different data types for code values (CHAR, DATE & NUM)
# 23-Sep Uses '||' as delimiter between code and code.name (for character data types)
# 24-Sep SAVEPOINT (RMD file committed to TortoiseHg)
# 24-Sep Moved datamart working directory to 'bc-datamart'
# 25-Sep Restructured error handling
# 25-Sep SAVEPOINT (RMD file committed to TortoiseHg) 
# 25-Sep Provide all encounters, eligible and ineligible for the study
# 25-Sep SAVEPOINT (RMD file committed to TortoiseHg)
# ============================================================================
```

### Package Set-Up and Initialization 

```{r Package Set-Up, include=FALSE}

# Include PHM function libraries
source('/d1/home/vleonardo/PHM-Development/PHM-LIBRARY.rmd')  # Loads PHM functions
# library(ggplot2)
library(reshape)
PHM.PackageSetup()

# Don't wrap so much
options(width=300)
opts_chunk$set(echo=FALSE)

# BC Function library
source('/d1/home/vleonardo/GPC-Development/bc_qa/bc_qa_txform.R')  
```

```{r AddVariable - Add new column to aggregated datamart, based on search strings}
BCRup.AddVariableToDatamart <- function(p.datamart, p.site.ptobs, 
                                        p.code.string.1, p.code.string.2, 
                                        p.new.col.name, p.code.data.type) {

  # NOTE: Search terms must be found in both 'variable name' and 'concept path'
  # NOTE: Ignores case and punctuation in the concept path  
  
  tmp.log.record <- list("")
  tmp.valid.terms.flag <- TRUE
  tmp.new.col.descriptor.name <- paste0(p.new.col.name,".Descriptor")  # Used for CHAR data types
  tmp.datamart <- p.datamart
  
  # Check for matching variable -----------------------------------------------------
  message("Checking variable to be added: ",p.new.col.name) 
  # Ensure only 1 variable matches search terms
  message("... searching variable names containing: '",
          p.code.string.1,"' & '",p.code.string.2,"'")
  tmp.var.found.cnt <- nrow(subset(bs, 
                          grepl(p.code.string.1,variable,ignore.case=TRUE) &
                          grepl(p.code.string.2,variable,ignore.case=TRUE) ))  
  message("Number of variables found matching search terms: ",tmp.var.found.cnt)
                          
  # Variable not found!
  if (tmp.var.found.cnt == 0) {
    tmp.msg <- "Unable to find a variable matching search terms."
    tmp.action.taken <- "WARNING: Variable values will be set to NA."
    tmp.log.record <- data.frame(p.new.col.name,p.code.string.1,p.code.string.2,
                                tmp.msg,tmp.action.taken)
    v.script.log <<- rbind(v.script.log, 
                          tmp.log.record) 
    tmp.valid.terms.flag <- FALSE
    } 
  
  # More than ONE variable found!
  if (tmp.var.found.cnt > 1) {
    tmp.msg <- "Collision where multiple variables found matching search strings."
    tmp.action.taken <- "WARNING: Values from multiple variables merged into one column."
    tmp.log.record <- data.frame(p.new.col.name,p.code.string.1,p.code.string.2,
                           tmp.msg,tmp.action.taken)
    v.script.log <<- rbind(v.script.log, 
                          tmp.log.record) 
    }
  
  # Search and load any matching observation facts -----------------------------------------------------  
  message("Checking patient data (observation facts) for populated concept codes: ",p.new.col.name) 
  message("... searching facts for concept paths containing: '",
          p.code.string.1,"' & '",p.code.string.2,"'") 
  tmp.new.col.facts <- subset(p.site.ptobs, 
                              grepl(p.code.string.1,code.path,ignore.case=TRUE) &
                              grepl(p.code.string.2,code.path,ignore.case=TRUE) )   
  tmp.new.col.facts <- unique(tmp.new.col.facts[,c("patient.num","encounter.num",
                                                   "code","code.name","nval","start.date.char")]) 
  tmp.ncf.cnt <- nrow(tmp.new.col.facts)  # Necessary for knitr markdown 
  message("... number of unique records found: ",tmp.ncf.cnt)
  message("... number of unique values founds: ",length(unique(tmp.new.col.facts$code)))
  
    
  # Check for matching observation facts -----------------------------------------------------  
  if (tmp.valid.terms.flag) {
    if (! (p.code.data.type %in% c("CHAR","NUM","DATE"))) {
      tmp.msg <- "Datatype specified is not supported."
      tmp.action.taken <- "WARNING: Using simple code values for column."
      tmp.log.record <- data.frame(p.new.col.name,p.code.string.1,p.code.string.2,
                                  tmp.msg,tmp.action.taken)
      v.script.log <<- rbind(,v.script.log,tmp.log.record)
      }
    
    if (tmp.ncf.cnt > nrow(p.datamart)) {
        message("... verifying cardinality of result set for variable requested.")
        tmp.msg <- "Cardinality of variable does not correspond with desired result set."
        tmp.action.taken <- "WARNING: Variable values will be set to NA."
        tmp.log.record <- data.frame(p.new.col.name,p.code.string.1,p.code.string.2,
                                     tmp.msg,tmp.action.taken)
        v.script.log <<- rbind(v.script.log, 
                               tmp.log.record) 
        tmp.valid.terms.flag <- FALSE
    } else {
      # Ensure observation facts exist for search terms
      message("ncf: ",tmp.ncf.cnt)
      if (tmp.ncf.cnt == 0) {
        tmp.msg <- "Unable to locate any facts for search strings in concept paths."
        tmp.action.taken <- "WARNING: Variable values will be set to NA."
        tmp.log.record <- data.frame(p.new.col.name,p.code.string.1,p.code.string.2,
                                     tmp.msg,tmp.action.taken)
        v.script.log <<- rbind(v.script.log, 
                               tmp.log.record) 
        tmp.valid.terms.flag <- FALSE
      }
    }
  }

  #------------------------------------------------------------------------------------
  # All conditions handled, proceed w/ adding variable values to datamart 
  # -- Invalid terms will have NAs loaded
  #-----------------------------------------------------------------------------------
  if (tmp.valid.terms.flag) {
    # Handle based on data type
    if (p.code.data.type == "NUM") {
      tmp.new.col.facts <- tmp.new.col.facts[,c("patient.num","encounter.num","nval")]
      tmp.new.col.facts <- setNames(tmp.new.col.facts,c("patient.num","encounter.num",
                                                      p.new.col.name))
    } else {
      if (p.code.data.type == "DATE") {
        # Use start.date.char to get hh:mm:ss
        tmp.new.col.facts <- tmp.new.col.facts[,c("patient.num","encounter.num","start.date.char")]
        tmp.new.col.facts <- setNames(tmp.new.col.facts,c("patient.num","encounter.num",
                                                      p.new.col.name))
      } else {
        if (!(p.code.data.type %in% c("NUM","DATE"))) {  # Handle as CHAR, includes unsupported data types
          tmp.new.col.facts <- tmp.new.col.facts[,c("patient.num","encounter.num","code","code.name")]
          tmp.new.col.facts <- setNames(tmp.new.col.facts,c("patient.num","encounter.num",
                                                      p.new.col.name,tmp.new.col.descriptor.name))
        } 
      }    
    }
    tmp.new.col.facts <- unique(tmp.new.col.facts)
    tmp.datamart <- merge(tmp.datamart, tmp.new.col.facts,
                          all.x=TRUE)  # don't prune on join mis-matches         
    tmp.msg <- "Search terms found."
    tmp.action.taken <- "Successfully added new column!"
    tmp.log.record <- data.frame(p.new.col.name,p.code.string.1,p.code.string.2,
                                 tmp.msg,tmp.action.taken)
    message(tmp.action.taken)
    v.script.log <<- rbind(v.script.log, 
                           tmp.log.record)  # Assign value to global variable
  } else { # Terms are not valid, so simply return nulls instead
    message("... assigning NAs to invalid term.")
    tmp.datamart[,p.new.col.name] <- NA
          if (!(p.code.data.type %in% c("NUM","DATE"))) {  # Handle as CHAR, includes unsupported data types
            tmp.datamart[,tmp.new.col.descriptor.name] <- NA
          }
  }
  return(tmp.datamart)
}
```

```{r DescribeDatamartColumn - Generate frequency and distribution charts}
# Note - ignores case and punctuation n the concept path
BCRup.DescribeDatamartColumn <- function(p.datamart,p.col.idx) {
 
     tmp.col.name <- names(p.datamart[p.col.idx])
     tmp.col.found.flag <- (nrow(p.datamart[! (is.na(p.datamart[,tmp.col.name])),]) > 0)
     if  (! tmp.col.found.flag) {
       message("No 'Descriptive Analysis', as only NAs are present for column: ",tmp.col.name) 
       return("No 'Descriptive Analysis' performed")
       }

    # Convert dates from character to date format
    if (grepl(".date$",tmp.col.name,ignore.case=TRUE) ) { # Handle as date, '$' checks for end of string
       p.datamart[,tmp.col.name] <- as.POSIXct(p.datamart[,tmp.col.name],"%y-%m-%d %T")
       } 
    
    if (grepl(".date$|.num$",tmp.col.name,ignore.case=TRUE)) {
       print(summary(p.datamart[,tmp.col.name]))
       hist(p.datamart[,tmp.col.name],
            breaks="days", format="%b %y",
            main=tmp.col.name,
            col=c("lightsteelblue"),
            xlab="")
    } else {if (grepl("date.",tmp.col.name,ignore.case=TRUE)) {
              message("Prior date variable not yet supported")
              }
            else {# Handle as character
       # Descriptive analysis for variable added
       tmp.frequency.table <- as.data.frame(addmargins(table(p.datamart[,p.col.idx])))
       tmp.frequency.table <- tmp.frequency.table[,c("Freq","Var1")]
       colnames(tmp.frequency.table)[colnames(tmp.frequency.table)=="Var1"] <- tmp.col.name
       colnames(tmp.frequency.table)[colnames(tmp.frequency.table)=="Freq"] <- "Enctrs"
  
       print(tmp.frequency.table, right=FALSE)  
       # print(summary(tmp.frequency.table[,tmp.col.name]))  # Only applies to numeric or date columns
           
       # Charts
       pie(table(p.datamart[,tmp.col.name]),
           main=tmp.col.name)  # 3 is code
    
       tmp.frequency.table2 <- aggregate(p.datamart$encounter.num, 
                              by=list(p.datamart[,tmp.col.name]), 
                              function(x) length(unique(x)))
       tmp.frequency.table2 <- tmp.frequency.table2[order(tmp.frequency.table2$x,decreasing=TRUE),]
       tmp.row.cnt <- nrow(tmp.frequency.table2)
       tmp.max.analysis.cnt <- min(7,tmp.row.cnt)
       tmp.chart.subtitle <- "All Occurrences"
       if (tmp.row.cnt > tmp.max.analysis.cnt) {
           tmp.chart.subtitle <- paste0("Most Frequence Occurrences (Top ",tmp.max.analysis.cnt," of ",tmp.row.cnt,")")
       }
       tmp.frequency.table2 <- tmp.frequency.table2[1:tmp.max.analysis.cnt,]  
       op <- par(mar=c(5,4,3,2),bg="white")   # Bottom, left, top, right
       bp <- barplot(tmp.frequency.table2$x,
                       horiz=TRUE,
                       xlim=c(0,max(tmp.frequency.table2$x)*1.25),
                       col=c("lightsteelblue"),
                       #width allows all x labels to be shown
                       xlab="Encounters (Tumors)")         
       text(bp, x=0, labels=tmp.frequency.table2$Group.1, pos=4, cex=.85)
       mtext(side=3, line=1, tmp.col.name, font=2)
       mtext(side=3, line=0, tmp.chart.subtitle) 
       par(op)  # reset
       }
   }
}
```

### Loading 'dataset' object

```{r}
#input <- source('dataset.R')$value

# conn.site <- input$conn

# about has $record_id $site name, $bc_db filename, $content_length, submitter $name, $issues_other
# dataset <- input$about

setwd('/d1/home/vleonardo/GPC-Development/bc-data-files')  
dataset <- list("")
dataset$site <- "KUMC"
# dataset$bc_db <- "bc-redo-alpha-2015-09-08"
# dataset$bc_db <- "bc-redo-subset"
dataset$bc_db <- "KUMC-16-kumcBC"

message('Dataset identified: ',dataset$site)
conn.site <- dbConnect(SQLite(),paste0('/d1/home/vleonardo/GPC-Development/bc-data-files/',dataset$bc_db,".db") )
print(dbListTables(conn.site))

# builder.summary reads raw db
bs <- (builder.summary(conn.site)[, c('variable', 'pat_qty', 'enc_qty', 'fact_qty')])
print(bs)

# Load site's variable and concept codes directly from db file
site <- list("")
site$variables <- dbGetQuery(conn.site,"select * from variable")
print(site$variables[,c("concept_path","name_char")])
site$concept.codes <- dbGetQuery(conn.site,"select * from concept_dimension")

# Diagnostics for site's data
message('SQLITE db file) patient_dimension: ',
        dbGetQuery(conn.site,"select count(*) from patient_dimension"))
message('SQLITE db file) variable: ',
        dbGetQuery(conn.site,"select count(*) from variable"))
message('SQLITE db file) concept_dimension: ',
        dbGetQuery(conn.site,"select count(*) from concept_dimension"))
message('SQLITE db file) observation_fact: ',
        dbGetQuery(conn.site,"select count(*) from observation_fact"))

```

### Load and Merge Observations With Concept Descriptors

``` {r}
############################################################################
# Delaware: n=4660583
# Expected Run-time: 6.5 mins
site$ptobs <- PHM.LoadObservationsWithConceptDescriptors(conn.site)

saveRDS(site$ptobs,  paste0(dataset$bc_db,"-",Sys.Date(),"-pt-obs.rds"))
print(nrow(site$ptobs))
site$ptobs.code.paths <- unique(site$ptobs$code.path)                           
```

### Loading original patient data for `r dataset$site'
 -- variables used in QA process (exclusion criteria and receptor status)

```{r}
load("/d1/home/vleonardo/GPC-Development/bc_qa/bc_terms_results.RData")
message('Number of terms loaded: ',nrow(bcterm$term204))

tumor.site <- bc.exclusions(conn.site)   

print(names(tumor.site))
saveRDS(tumor.site,  paste0(dataset$bc_db,"-",Sys.Date(),"-tumor-site.rds"))
x.tumor.site <- tumor.site  # Holding area for restoration/debugging purposes
#tumor.site <- readRDS(paste0(dataset$bc_db,"-",Sys.Date(),"-tumor-site.rds"))
message('Number of tumors loaded: ',(nrow(tumor.site)))
message('Number of pts in dataset: ',length(unique(tumor.site$patient_num)))


survey.sample <- check.cases(tumor.site)  # Creates tumor-level criteria flags
survey.sample$all.criteria <- reduce.logical(survey.sample)
message('Number of pts meeting inclusion criteria: ', 
        nrow(survey.sample[survey.sample$all.criteria,]))

survey.sample.summary <- count.cases(survey.sample)  # Produce table of criteria counts
print(survey.sample.summary)
```

### Filter for only eligible encounters(tumors)
```{r}
# Remove original receptor status variables f/ inclusion set, as they are replicated in NAACCR vars
tumor.site <- subset(tumor.site,select=-c(er.csf.1,pr.csf.2,her2.csf.15,mgs.method.csf.22,mgs.score.csf.23))

tumor.site <- merge(tumor.site,survey.sample[,c("patient_num","encounter_num","all.criteria")])
colnames(tumor.site)[colnames(tumor.site)=="patient_num"] <- "patient.num"
colnames(tumor.site)[colnames(tumor.site)=="encounter_num"] <- "encounter.num"
colnames(tumor.site)[colnames(tumor.site)=="all.criteria"] <- "enctr.eligible"

# Add prefix to survey variables to distinguish them from TR & EHR direct-sourced items
for (i in 3:ncol(tumor.site)) {
  tmp.col.name <- names(tumor.site[i])
  colnames(tumor.site)[colnames(tumor.site)==tmp.col.name] <- paste0("gpc.",tmp.col.name)
}

message("Total number of patients submitted: ", length(unique(tumor.site$patient.num)))
message("Total number of encounters submitted: ", length(unique(tumor.site$encounter.num)))
message("Number of eligible patients: ", length(unique(tumor.site$patient.num[tumor.site$gpc.enctr.eligible])))
message("Number of eligible encounters(tumors): ", nrow(tumor.site[tumor.site$gpc.enctr.eligible,]))
```

### Trim master patient observations for only eligible encounters, solely for performance reasons

```{r}
site$ptobs <- subset(site$ptobs, encounter.num %in% tumor.site$encounter.num)
print(nrow(site$ptobs))
```


### Add next variables, specifying 2 search terms for 'variable name'

```{r}
# Variable Initialization
v.script.log <- data.frame(p.new.col.name="",p.code.string.1="",p.code.string.2="",tmp.msg="",tmp.action.taken="")
message("Rows in tumor.site: ", nrow(tumor.site))
tmp.tumor.site <- tumor.site

# Add GPC Site Identifier
tmp.tumor.site <- cbind(gpc.site=dataset$site,tmp.tumor.site)

# Add each variable
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'Breast','Breast', 'Seer.Site.Breast','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0160','race 1', 'NAACCR.0160.Race.1','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0161','race 2', 'NAACCR.0161.Race.2','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0162','race 3', 'NAACCR.0162.Race.3','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0163','race 4', 'NAACCR.0163.Race.4','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0164','race 5', 'NAACCR.0164.Race.5','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0190','spanish', 'NAACCR.0190.Spanish','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0220','sex', 'NAACCR.0220.Sex','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0240','birth', 'NAACCR.0240.Birth.Date','DATE')  # Date of birth
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0380','central', 'NAACCR.0380.Seqno.Central','CHAR')  # Seqno Central
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0390','diagnosis', 'NAACCR.0390.Dx.Date','DATE')  # Date of diagnosis
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0400','primary', 'NAACCR.0400.Primary.Site','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0410','laterality', 'NAACCR.0410.Laterality','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0440','grade', 'NAACCR.0440.Grade','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0490','confirmation', 'NAACCR.0490.Confirmation','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0560','hospital', 'NAACCR.0560.Seqno.Hosp','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0610','class', 'NAACCR.0610.Class.Case','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0670','surg', 'NAACCR.0670.Surg.Prim.Site','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0820','positive', 'NAACCR.0820.Reg.Nodes.Pos','CHAR')  # Regional Nodes Positive
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'0830','examine', 'NAACCR.0830.Reg.Nodes.Examined','CHAR')  # Regional Nodes Examined
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'1750','contact', 'NAACCR.1750.Last.Contact.Date','DATE')  
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'1760','vital', 'NAACCR.1760.Vital.Status','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'1860','recurrence', 'NAACCR.1860.Recurrence.Date','DATE')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'1861','flag', 'NAACCR.1861.Recurrence.Date.1st.Flag','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'2850','dx', 'NAACCR.2850.CSMets.Dx','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'2860','eval', 'NAACCR.2860.CSMets.Eval','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'2869','factor', 'NAACCR.2869.CSSF.15','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'2876','factor', 'NAACCR.2876.CSSF.22','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'2877','factor', 'NAACCR.2877.CSSF.23','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'2880','factor', 'NAACCR.2880.CSSF.01','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'2890','factor', 'NAACCR.2890.CSSF.02','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'2940','AJCC-6', 'NAACCR.2940.AJCC-6.T','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'3000','AJCC-6', 'NAACCR.3000.AJCC-6.Stage','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'3020','SS2000', 'NAACCR.3020.SS2000','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'3400','AJCC-7', 'NAACCR.3400.AJCC-7.T','CHAR')
tmp.tumor.site <- BCRup.AddVariableToDatamart(tmp.tumor.site, site$ptobs,'3430','AJCC-7', 'NAACCR.3430.AJCC-7.Stage','CHAR')

tumor.site <- tmp.tumor.site

# Summary of actions taken
names(tumor.site)
message("Rows in tumor.site: ", nrow(tumor.site))
print(v.script.log)
message("Flagged Issues w/ Variables")
print(v.script.log[!grepl("Success",v.script.log$tmp.action.taken),])
```

### Descriptive Analysis for Each Datamart Variable

```{r Descriptive Analysis}
#for (tmp.col.index in 24:27) # Skip P#, E# and Site columns
for (tmp.col.index in 4:(ncol(tumor.site))) # Skip P#, E# and Site columns
  {  
  BCRup.DescribeDatamartColumn(tumor.site,tmp.col.index) 
  #BCRup.DescribeDatamartColumn(tmp.tumor.site,39) 
  }
```

```{r Send patient sampling to CSV file}
setwd('/d1/home/vleonardo/GPC-Development/bc-datamart')  

message(paste('Output directory: ',getwd()) )
v.filename <- paste0(dataset$site,"-",dataset$record_id,"-BCDatamart.csv")
write.csv(tumor.site, file = v.filename, row.names=FALSE)
message('Tumor-level datamart: ',v.filename)
message('... ',nrow(tumor.site),' rows written.')
```