```{r create_basic_documentation, echo=TRUE}
doc <- NULL
doc$run.date <- date()
doc$version <- system(' git rev-parse HEAD', intern=TRUE)
doc$author <- "Steve Simon (KUMC)"
doc$maintainer <- "Steve Simon (KUMC)"
doc$assistants <- "Dan Connolly"
```


Case-control
============
For context, see [485].

[485]: https://informatics.gpcnetwork.org/trac/Project/ticket/485
[bc_qa]: https://bitbucket.org/gpcnetwork/bc_qa

This program analyzes a case-control data set. It produces some simple
tables and graphs.

A companion program, extract_case_control, produces the data set
used by this program.

This program was run on `r doc$date` using version `r doc$version`.
The original author is `r doc$author`. `r doc$maintainer`
is currently maintaining and enhancing this program
with the assistance of `r doc$assistants`.


```{r load_required_libraries, echo=TRUE}
library("ggplot2")
save.image("backup.RData")
rm(list=ls())
cat("\n\nQuality check: Are we in the correct directory?")
getwd()
# Don't wrap so much
options(width=90)
# Load the case-control data sets
load("extract_case_control.RData")
```


While you can get the nice labels for icd9 codes from i2b2, it is easier
just to pull them from another source. I chose labels from the
[https://www.cms.gov/medicare/coding/ICD9providerdiagnosticcodes/codes.html CMS]
site. 

Until I get some of the mismatches figured out, I won't try out this code.

```{r get-nice-names, echo=TRUE, eval=FALSE}
# il = icd9_labels
icd9_file <- "icd9_labels.csv"
il <- read.csv(icd9_file, header=TRUE, as.is=TRUE, row.names=NULL)
# Double check to make sure nothing was converted to factors.
sapply(il,is.factor)
il$nice_label <- paste(strip_specials(il$short_label),il$DX,sep="_")
list_random_rows(il$nice_label)
sort(setdiff(di$DX,il$DX))
sort(setdiff(il$DX,di$DX))
```

The event counts are pretty easy to get now. This code
might, however, run better if you do the counting in
SQL instead.

```{r get-event-counts, echo=TRUE}
ec <- table(dj$DX,dj$GP)
list_random_rows(ec)
```

```{r calculate-sensitivity-etc, echo=TRUE}
disease_counts <- table(dp_stack$GP)
total_matrix <- outer(rep(1,dim(ec)[[1]]),disease_counts)
ex <- outer(rep(1,dim(ec)[[1]]),disease_counts) - ec
list_random_rows(ex)

# Sensitivity is the same for each different control group.
# Specificity, etc. changes depending on the control group.

# This program assumes that the cases are in column i.case
i.case <- 1

sens <- round(100*ec[, i.case] / total_matrix[, i.case])
list_random_rows(sens)

spec <- round(100*ec[, -i.case] / total_matrix[, -i.case])
list_random_rows(spec)

ppv.num <- ec[, rep(i.case, length(disease_counts)-1)]
ppv.den <- ppv.num + ec[, -i.case]
ppv   <- round(100*ppv.num / ppv.den)
dimnames(ppv)[[2]] <- names(disease_counts[-i.case])
list_random_rows(ppv)

npv.num <- ex[, rep(i.case, length(disease_counts)-1)]
npv.den <- npv.num + ex[, -i.case]
npv   <- round(100*npv.num / npv.den)
list_random_rows(npv)


high_ppv <- apply(ppv > 60, 1, all)
list_random_rows(high_ppv)

best_variables <- ppv[high_ppv, ]

dim(best_variables)
print(best_variables)
```

```{r save-everything, echo=TRUE}
save.image(file="case_control.RData")
```
