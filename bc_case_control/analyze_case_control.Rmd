```{r create-basic-documentation, echo=TRUE}
doc <- NULL
doc$run.date <- date()
doc$version <- system(' git rev-parse HEAD', intern=TRUE)
doc$author <- "Steve Simon (KUMC)"
doc$maintainer <- "Steve Simon (KUMC)"
doc$assistants <- "no one just yet"
```

This program reads data from an i2b2 query and produces
simple analyses and graphs. It stores the data and some
intermediate files in an RData file.

This program was run on `r doc$date` using version `r doc$version`.
The original author is `r doc$author`. `r doc$maintainer`
is currently maintaining and enhancing this program
with the assistance of `r doc$assistants`.

```{r load-required-libraries, echo=TRUE}
library("ggplot2")
library("reshape")
library("RSQLite")
save.image("backup.RData")
rm(list=ls())
```

```{r set-options, echo=TRUE}

# Don't wrap so much
options(width=100)

```

Case-control
============
For context, see [485].

[485]: https://informatics.gpcnetwork.org/trac/Project/ticket/485
[bc_qa]: https://bitbucket.org/gpcnetwork/bc_qa

```{r setup-sql-queries, echo=TRUE}

# use-this-database.txt should have one entry in the first line,
# the name of the database. Anything after the first line is ignored.

# Note: ca = case, co = control.

setwd("/d1/home/ssimon/bc_qa/bc_case_control")
db_name <- read.table(file="use_this_database.txt", stringsAsFactors=FALSE)[1, 1]
cat("\n\nReading data from ",db_name,".\n")
conn_site <- dbConnect(SQLite(), dbname=db_name)

sql_query <-NULL
db <- NULL
```

```{r run-sql-queries}

# read the observation_fact table for cases only, removing duplicates.
sql_query[["ca"]] <-
  "select distinct obs.patient_num, obs.concept_cd
   from observation_fact obs
   where obs.patient_num in (
     select distinct ca.patient_num
     from observation_fact ca where ca.concept_cd = 'SEER_SITE:26000'
   )"

# read the observation_fact table for controls only, removing duplicates.
sql_query[["co"]] <-
  "select distinct obs.patient_num, obs.concept_cd
   from observation_fact obs
   where obs.patient_num in (
     select distinct ca.patient_num
     from observation_fact ca where ca.concept_cd LIKE ('SEER_SITE:220' || '_%')
   )"

# read the concept_dimension table.
sql_query[["concepts"]] <-
  "select distinct concept_cd, name_char
   from concept_dimension
   order by concept_cd"

for (i in names(sql_query)) {
  cat("\nRunning ",i," query.\n\n",sep="")
  db[[i]] <- dbGetQuery(conn_site, sql_query[[i]])
  print(head(db[[i]]))
}
sapply(db,dim)

n_ca <- length(unique(db$ca$patient_num))
n_co <- length(unique(db$co$patient_num))
```

There are `r length(unique(db$ca$patient_num))` cases and
`r length(unique(db$co$patient_num))` controls.

```{r reshape-event-information, echo=TRUE}
library("reshape2")

# equal to 1 unless NULL

db$all <- rbind(data.frame(db$ca,group="t+;d+"), data.frame(db$co,group="t+;d-"))

db$counts <- dcast(db$all, group ~ concept_cd, length)
db$counts[, 1] <- as.character(db$counts[, 1])
db$counts[1:2, 1:5]

unique_concepts <- db$concepts[!duplicated(db$concepts$concept_cd), ]
predictors <- unlist(dimnames(db$counts)[2])[-1]
labels <- merge(data.frame(concept_cd=predictors),unique_concepts)
labels$name_char <- substr(labels$name_char,1,50)
head(labels)
# unlist will turn the 1 by n matrix into a vector.
t_pos_d_pos  <- unlist(db$counts[1,-1])
t_pos_d_neg <- unlist(db$counts[2,-1])

t_neg_d_pos <- n_ca - t_pos_d_pos
t_neg_d_neg <- n_co - t_pos_d_neg

ppv  <- round(100*t_pos_d_pos / (t_pos_d_pos+t_pos_d_neg))
npv  <- round(100*t_neg_d_neg / (t_neg_d_pos+t_pos_d_neg))

sens <- round(100*t_pos_d_pos / (t_pos_d_pos+t_neg_d_pos))
spec <- round(100*t_neg_d_neg / (t_neg_d_neg+t_pos_d_neg))

lp <- "("
rp <- ")"
sl <- "/"
sp <- " "
pc <- "%"
ppv_labels <- paste(ppv, pc, sp, lp, t_pos_d_pos, 
                    sl, t_pos_d_pos+t_pos_d_neg, rp,
                    sp,predictors,sp,labels$name_char,sep="")
high_ppv <- ppv>90 & t_pos_d_pos > 100
# Re-arrange so that highest numerators appear first.
o <- rev(order(t_pos_d_pos[high_ppv]))
ppv_labels[high_ppv][o]
```


```{r save-everything, echo=TRUE}
save.image(file="case_control.RData")
```
