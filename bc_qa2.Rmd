Breast Cancer QA: Query Terms and Exclusion Criteria
====================================================

```{r, echo=FALSE}
# Don't wrap so much
options(width=300) 
```

*Transformation utilities:*

```{r}
source('bc_qa_txform.R')
```


Query sent to GPC sites 12/23/2014:

  - [GPC Honest Brokers: Time to run the breast cancer survey query][23dec]  
    Tamara McMahon  
    Tue Dec 23 16:17:23 CST 2014 

[23dec]: http://listserv.kumc.edu/pipermail/gpc-honest-brokers/2014-December/000002.html

As noted in [ticket:204][204], the query is on babel, where a few revisions have been incorporated.

[204]: https://informatics.gpcnetwork.org/trac/Project/ticket/204

`Breast_Cancer_20150223.xml` is the query definition as of this writing, and `bc-variable.csv` is derived from it via `qterms.py`.


```{r}
bcterm <- list()

term204 <- read.csv('bc-variable.csv',
                    stringsAsFactors=FALSE)

term204$name <- strip.counts(term204$name_char)
term204 <- term204[, c('id', 'concept_path', 'name')]

term204$naaccr.code <- substr(term204$name, 1, 4)
```

*We seem to have `r length(which(duplicated(term204$concept_path)))` duplicates:*

```{r echo=FALSE, results='asis'}
ht(
  term204[duplicated(term204$concept_path), ]
  )
```

Let's eliminate them:

```{r}
data.frame(
  term.qty=nrow(term204),
  term.uniq.qty=length(unique(term204$concept_path))
  )
term204 <- term204[!duplicated(term204$concept_path), ]

bcterm$term204 <- term204
```

These are the `r nrow(term204)` query terms:

```{r, echo=FALSE, results='asis'}

ht(
  term204[, c('concept_path', 'name')]
  )
```

### Alignment by "patching"

We can accomodate analagous paths to a certain extent; e.g. the "Abridged" NAACCR hierarchy:

```{r echo=FALSE}
bcterm$fixes <- read.csv(textConnection(
    'from,to
\\i2b2\\Abridged\\Demographics,\\i2b2\\naaccr\\S:2 Demographic
\\I2B2\\Cancer Cases\\0,\\i2b2\\naaccr\\S:
\\I2B2\\Cancer Cases\\1,\\i2b2\\naaccr\\S:1
\\I2B2\\Cancer Cases\\SEER Site Summary,\\i2b2\\naaccr\\SEER Site
\\I2B2\\Demographics,\\i2b2\\Demographics
Type and Behav ICD-O-3,Type&Behav ICD-O-3
'))
```

```{r}
bcterm$fixes
```

## BreastCancer Diagnosis

The core breast cancer diagnosis term comes from the SEER site recode:

```{r}
bcterm$bc.dx.path <-
  grep('\\SEER Site\\Breast\\',
     term204$concept_path,
     value=TRUE, fixed=TRUE)

bcterm$bc.dx.path
```

## Exclusion Criteria

In [Share Thoughts on Breast Cancer Study][18Dec] GPC Global Webinar, December 18, 2014, on Slide 8 *Selection Criteria*:

[18Dec]: http://listserv.kumc.edu/pipermail/gpc-all/attachments/20141215/f655d41b/attachment-0001.pptx

> Exclude from the SURVEY sample if:
>  - Sex not equal to female
>  - Less than 18 years of age
>  - Prior cancer diagnosis
>  - Breast cancer was not microscopically confirmed
>  - Only tumor morphology was lobular carcinoma in situ
>  - Stage IV breast cancer
>  - Known to be deceased
>  - Non-English speaking (for now)

**TODO: Language**

Note that stage (AJCC, SS2000) and Vital Status are combinations of terms:

```{r echo=FALSE}
t.excl <- data.frame(
  naaccr.code=c('0220',
                '0240',
                '1760',
                '0490',
                '0521',
                '3020',
                '3430',
                '0380'),
  stringsAsFactors=FALSE
  )

t.excl <- merge(t.excl, term204[, c('naaccr.code', 'name', 'concept_path')],
                by='naaccr.code', all.x=TRUE, sort=FALSE)

deceased.ehr <- merge(
  data.frame(
  concept_path=c(
    '\\i2b2\\Demographics\\Vital Status\\Deceased\\',
    '\\i2b2\\Demographics\\Vital Status\\Deceased per SSA\\'
    )),
  term204[, c('name', 'concept_path')],
  by='concept_path')
deceased.ehr$naaccr.code <- NA

combo <- data.frame(
  name=c('stage', 'vital'),
  naaccr.code=NA,
  concept_path=NA)
t.excl <- rbind(t.excl, combo, deceased.ehr)

row.names(t.excl) <- c('sex', 'date.birth',
                       'vital.tr',
                       'confirm', 'morphology',
                       'stage.ss', 'stage.ajcc',
                       'seq.no',
                       'stage',
                       'vital', 'deceased.ssa', 'deceased.ehr')
bcterm$excl.all <- t.excl


bcterm$excl <- t.excl[c('sex', 'date.birth', 'vital',
                        'confirm', 'morphology', 'stage', 'seq.no'), ]
```

```{r echo=FALSE, results='asis'}
ht(caption="Exclusion Criteria Terms (All)",
   bcterm$excl.all)
ht(caption="Exclusion Criteria Terms (Primary)",
   bcterm$excl)
```

## Save For Next Section

```{r}
save(bcterm, file="bc_terms_results.RData")
```
