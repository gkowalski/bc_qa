Breast Cancer QA Part 2: Site Data Summary
==========================================

Choose the site in this auxiliary file:

```{r}
SITE <- source('bc_site.R')$value
```

*Transformation and access utilities:*

```{r}
source('bc_qa_txform.R')
```


```{r, echo=FALSE}
# Don't wrap so much
options(width=300) 
```


Recall the results of fetching the files:

```{r}
load("bc_download.RData")
dataDir
names(got)

submission$record_id <- as.numeric(row.names(submission))
current <- submission[submission$obsolete == '', ]
nrow(current)
```

The following `r nrow(current)` records are current:

```{r}
current[c('record_id', 'name', 'institution')]
```

## Connecting File Info with CRF Info

```{r}
fileinfo <- (function() {
  filedesc <- grep('patients', got$normalizelog, value=TRUE)
  m <- regexec('[^:]+:[^:]+:(([^-]+)-([0-9]+)[^ ]+) has ([0-9]+) patients.', filedesc)
  lm <- regmatches(filedesc, m)
  df <- do.call(rbind.data.frame, lm)
  names(df) <- c('line', 'filename', 'site', 'record_id', 'n.patient')
  row.names(df) <- df$record_id
  df$record_id <- as.numeric(as.character(df$record_id))
  df[order(df$record_id), -1]
  })()
fileinfo
```

Now we can merge the file info with the redcap data:

```{r}
current$filename <- fileinfo$filename
current$site <- fileinfo$site
current$n.patient <- fileinfo$n.patient
current[, c('site', 'n.patient', 'filename')]
```


### SQL Queries on Site Data

For example:

```{r}
conn.site <- site.data(SITE, dataDir, current)
dbGetQuery(conn.site, 'select count(*) from patient_dimension')
```


### Site Data Summary

This is the [data summary query from BuilderSaga][sqlsum], tweaked to add encounter qty:

[sqlsum]: https://informatics.gpcnetwork.org/trac/Project/wiki/BuilderSaga#DataSummary

```{r}
conn.site <- site.data(SITE, dataDir, current)

builder.summary(conn.site)[, c('variable', 'pat_qty', 'enc_qty', 'fact_qty')]
```


## Save For Next Section

```{r}
save(dataDir, got, submission,
     current, site.data, builder.summary, strip.counts,
     file="bc_data_summary.RData")
```
